<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>JYSK Room Styler</title>
<style>
  :root { --brand:#003b70; }
  * { box-sizing: border-box; }
  body { font-family: Arial, sans-serif; background:#f4f4f4; margin:0; display:flex; flex-direction:column; align-items:center; }
  header { width:100%; background:var(--brand); color:#fff; text-align:center; padding:12px 10px; }
  .toolbar { margin:10px 0; display:flex; flex-wrap:wrap; gap:8px; justify-content:center; }
  .toolbar select, .toolbar button { padding:8px 12px; border:1px solid #ddd; border-radius:6px; }
  .toolbar .primary { background:var(--brand); color:#fff; border-color:var(--brand); }
  .workspace { width:100%; max-width:1200px; display:grid; gap:12px; grid-template-columns: 220px 1fr; padding:0 10px 16px; }
  .palette { background:#fff; border:1px solid #ddd; border-radius:8px; padding:10px; max-height:70vh; overflow:auto; display:grid; grid-template-columns:1fr; gap:10px; }
  .palette .card { display:flex; flex-direction:column; gap:6px; }
  .palette img { width:100%; height:auto; cursor:grab; border:1px solid #eee; border-radius:6px; background:#fff; }
  .palette .name { font-size:12px; color:#333; text-align:center; }
  .room-wrap { position:relative; width:100%; }
  .room-canvas {
    position:relative; width:100%;
    border:2px solid var(--brand); border-radius:8px; overflow:hidden; background:#fff;
    background-size: contain; background-repeat:no-repeat; background-position: bottom center;
    height: 60vh; max-height: 78vh; /* JS will refine height */
  }
  .draggable { position:absolute; cursor:move; user-select:none; }
  .draggable img { width:100%; height:auto; pointer-events:none; display:block; }
  .selected { outline:2px solid #ff5252; }
  .delete-btn { position:absolute; top:-10px; right:-10px; width:22px; height:22px; border:none; border-radius:50%;
    background:#ff5252; color:#fff; font-weight:bold; line-height:22px; cursor:pointer; display:none; }
  .draggable.selected .delete-btn { display:block; }
  #scoreRow { margin:8px 0 16px; font-weight:bold; display:flex; gap:16px; justify-content:center; }
  .hint { font-size:12px; color:#666; margin:4px 10px 16px; text-align:center; }
  @media (max-width: 900px) {
    .workspace { grid-template-columns: 1fr; }
    .palette { display:flex; gap:10px; overflow-x:auto; overflow-y:hidden; white-space:nowrap; max-height:none; order:2; }
    .palette .card { min-width:140px; }
  }
</style>
</head>
<body>
<header><h1>JYSK Room Styler</h1></header>

<div class="toolbar">
  <label for="themeSelect">Theme:</label>
  <select id="themeSelect">
    <option value="hygge">Hygge Living</option>
    <option value="nordic">Nordic Minimal</option>
  </select>
  <button class="primary" id="finishBtn">Finish & Score</button>
  <button id="resetBtn">Reset Room</button>
  <button id="downloadBtn">Download Image</button>
  <button id="rotateLeftBtn">Rotate ⟲</button>
  <button id="rotateRightBtn">Rotate ⟳</button>
  <button id="deleteSelectedBtn">Delete Selected</button>
</div>

<div class="workspace">
  <div class="palette" id="palette"></div>
  <div class="room-wrap"><div class="room-canvas" id="roomCanvas"></div></div>
</div>

<div id="scoreRow"><div id="scoreBox">Score: 0</div><div id="discountBox">Discount: 0%</div></div>
<div class="hint">Tip: Tap an item to add it. Tap placed items to select; drag to move; drag edges to resize. Use rotate buttons or [ / ] keys; press Delete to remove.</div>

<!-- libs -->
<script src="https://cdn.jsdelivr.net/npm/interactjs/dist/interact.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js"></script>

<script>
/* ---- config ---- */
const themes = {
  hygge:  { bg: "assets/backgrounds/hygge.png"  },
  nordic: { bg: "assets/backgrounds/nordic.png" }
};
const items = [
  { name:"VALTER Frame", src:"assets/realistic/frame.png" },
  { name:"Wall Mirror",  src:"assets/realistic/mirror.png" },
  { name:"Floor Lamp",   src:"assets/realistic/floor-lamp.png" },
  { name:"Armchair",     src:"assets/realistic/armchair.png" },
  { name:"Side Table",   src:"assets/realistic/side-table.png" },
  { name:"Coffee Table", src:"assets/realistic/coffee-table.png" },
  { name:"Plant",        src:"assets/realistic/plant.png" },
  { name:"Candle",       src:"assets/realistic/candle.png" },
  { name:"Decor Tray",   src:"assets/realistic/tray.png" },
  { name:"Cushion",      src:"assets/realistic/cushion.png" }
];
function getDiscount(score){ if (score>=100) return 20; if (score>=60) return 10; if (score>=30) return 5; return 0; }

/* ---- elements/state ---- */
const isLocal = location.protocol === 'file:'; /* important fix */
const palette = document.getElementById('palette');
const roomCanvas = document.getElementById('roomCanvas');
const themeSelect = document.getElementById('themeSelect');
const scoreBox = document.getElementById('scoreBox');
const discountBox = document.getElementById('discountBox');
let selectedEl=null, zCounter=10, latestScore=0, latestDiscount=0, bgAspect=3/2;

/* palette */
items.forEach(it=>{
  const card=document.createElement('div'); card.className='card';
  const img=document.createElement('img'); img.src=it.src; img.alt=it.name; img.title=it.name;
  img.addEventListener('click', ()=>addItemToRoom(it.src));
  const name=document.createElement('div'); name.className='name'; name.textContent=it.name;
  card.appendChild(img); card.appendChild(name); palette.appendChild(card);
});

/* theme load: set background immediately; compute aspect async */
function loadTheme(key){
  const url = themes[key].bg;
  roomCanvas.style.backgroundImage = `url('${url}')`; // set immediately so it shows even if onload fails
  // try to compute aspect for better height
  const bg = new Image();
  if (!isLocal) bg.crossOrigin='anonymous';
  bg.onload = ()=>{ if(bg.naturalWidth && bg.naturalHeight){ bgAspect = bg.naturalWidth/bg.naturalHeight; applyRoomHeight(); } };
  bg.src = url;

  roomCanvas.innerHTML=''; deselect(); updateScorePreview(); applyRoomHeight();
}
function applyRoomHeight(){
  const width = roomCanvas.clientWidth;
  const desired = Math.min(width / bgAspect, window.innerHeight * 0.78);
  roomCanvas.style.height = Math.max(380, desired) + 'px';
}
window.addEventListener('resize', applyRoomHeight);
themeSelect.addEventListener('change', ()=>loadTheme(themeSelect.value));

/* add draggable item (stored in %) */
function addItemToRoom(src, leftPct=5, topPct=5, widthPct=18){
  const wrap=document.createElement('div'); wrap.className='draggable';
  wrap.dataset.leftPct=leftPct; wrap.dataset.topPct=topPct; wrap.dataset.widthPct=widthPct; wrap.dataset.rotate=0;
  setPercentStyles(wrap,leftPct,topPct,widthPct); wrap.style.zIndex=++zCounter;

  const img=new Image();
  if (!isLocal) img.crossOrigin='anonymous'; // only when not local
  img.src=src; img.draggable=false;

  const del=document.createElement('button'); del.className='delete-btn'; del.textContent='×';
  del.onclick=(e)=>{ e.stopPropagation(); if(selectedEl===wrap) deselect(); wrap.remove(); updateScorePreview(); };

  wrap.appendChild(img); wrap.appendChild(del);
  wrap.addEventListener('mousedown', ()=>select(wrap));
  wrap.addEventListener('touchstart', ()=>select(wrap), {passive:true});
  roomCanvas.appendChild(wrap);
  makeInteractivePercent(wrap);
  updateScorePreview();
}
function setPercentStyles(el,leftPct,topPct,widthPct){
  el.style.left=leftPct+'%'; el.style.top=topPct+'%'; el.style.width=widthPct+'%';
  const r=parseFloat(el.dataset.rotate)||0; el.style.transform=`rotate(${r}deg)`;
}

/* interactions in % */
function makeInteractivePercent(el){
  interact(el)
    .draggable({ listeners:{ move(ev){
      const box=roomCanvas.getBoundingClientRect();
      const leftPx=(parseFloat(el.dataset.leftPct)||5)/100*box.width + ev.dx;
      const topPx =(parseFloat(el.dataset.topPct )||5)/100*box.height + ev.dy;
      const newLeftPct=Math.max(0,Math.min(100,leftPx/box.width*100));
      const newTopPct =Math.max(0,Math.min(100,topPx /box.height*100));
      el.dataset.leftPct=newLeftPct; el.dataset.topPct=newTopPct;
      setPercentStyles(el,newLeftPct,newTopPct,parseFloat(el.dataset.widthPct)||18);
    }}})
    .resizable({ edges:{left:true,right:true,top:true,bottom:true} })
    .on('resizemove', ev=>{
      const box=roomCanvas.getBoundingClientRect();
      const currWpx=(parseFloat(ev.target.dataset.widthPct)||18)/100*box.width;
      const newWpx=Math.max(40,currWpx + ev.deltaRect.width);
      const newWidthPct=Math.min(90,newWpx/box.width*100);
      const leftPx=(parseFloat(ev.target.dataset.leftPct)||5)/100*box.width + ev.deltaRect.left;
      const topPx =(parseFloat(ev.target.dataset.topPct)||5)/100*box.height + ev.deltaRect.top;
      const newLeftPct=Math.max(0,Math.min(100,leftPx/box.width*100));
      const newTopPct =Math.max(0,Math.min(100,topPx /box.height*100));
      ev.target.dataset.leftPct=newLeftPct; ev.target.dataset.topPct=newTopPct; ev.target.dataset.widthPct=newWidthPct;
      setPercentStyles(ev.target,newLeftPct,newTopPct,newWidthPct);
    })
    .gesturable({ listeners:{ move(ev){
      const r=(parseFloat(el.dataset.rotate)||0) + ev.da;
      el.dataset.rotate=r;
      setPercentStyles(el,parseFloat(el.dataset.leftPct)||5,parseFloat(el.dataset.topPct)||5,parseFloat(el.dataset.widthPct)||18);
    }}});
}

/* selection + rotate + delete */
function select(el){ if(selectedEl) selectedEl.classList.remove('selected'); selectedEl=el; el.classList.add('selected'); el.style.zIndex=++zCounter; }
function deselect(){ if(!selectedEl) return; selectedEl.classList.remove('selected'); selectedEl=null; }
document.body.addEventListener('click',(e)=>{ if(!roomCanvas.contains(e.target)) deselect(); });
document.getElementById('rotateLeftBtn').onclick = ()=>rotateSel(-10);
document.getElementById('rotateRightBtn').onclick= ()=>rotateSel(+10);
document.getElementById('deleteSelectedBtn').onclick= ()=>{ if(selectedEl){ selectedEl.remove(); selectedEl=null; updateScorePreview(); } };
document.addEventListener('keydown',(e)=>{
  if(!selectedEl) return;
  if(e.key==='Delete'){ selectedEl.remove(); selectedEl=null; updateScorePreview(); }
  if(e.key==='[') rotateSel(-5);
  if(e.key===']') rotateSel(+5);
});
function rotateSel(delta){ if(!selectedEl) return; const r=(parseFloat(selectedEl.dataset.rotate)||0)+delta; selectedEl.dataset.rotate=r;
  setPercentStyles(selectedEl,parseFloat(selectedEl.dataset.leftPct),parseFloat(selectedEl.dataset.topPct),parseFloat(selectedEl.dataset.widthPct)); }

/* scoring + discount + download */
function getScore(){ return roomCanvas.querySelectorAll('.draggable').length * 10; }
function getDiscountFromScore(s){ if(s>=100) return 20; if(s>=60) return 10; if(s>=30) return 5; return 0; }
function updateScorePreview(){
  const s=getScore(); const d=getDiscountFromScore(s);
  document.getElementById('scoreBox').textContent = `Score: ${s}`;
  document.getElementById('discountBox').textContent = `Discount: ${d}%`;
}
document.getElementById('finishBtn').onclick=()=>{ updateScorePreview(); latestScore=getScore(); latestDiscount=getDiscountFromScore(latestScore); };
document.getElementById('downloadBtn').onclick=async ()=>{
  if(!latestScore){ latestScore=getScore(); latestDiscount=getDiscountFromScore(latestScore); }
  const canvas = await html2canvas(roomCanvas, {
    backgroundColor:null, scale:2, useCORS: !isLocal, allowTaint: isLocal
  });
  const ctx = canvas.getContext('2d');
  const text = `Your JYSK discount: ${latestDiscount}% (5%–20%)`;
  ctx.font = "24px Arial";
  const pad = 16, w = ctx.measureText(text).width + pad*2;
  const x = (canvas.width - w)/2, y = canvas.height - 28;
  ctx.fillStyle = "rgba(255,255,255,0.92)"; ctx.fillRect(x, y-24, w, 30);
  ctx.fillStyle = "rgba(0,59,112,1)"; ctx.fillText(text, x+pad, y);
  const link=document.createElement('a'); link.download='my-room.png'; link.href=canvas.toDataURL('image/png'); link.click();
};

/* reset + init */
document.getElementById('resetBtn').onclick=()=>{ loadTheme(themeSelect.value); document.getElementById('scoreBox').textContent='Score: 0'; document.getElementById('discountBox').textContent='Discount: 0%'; };
loadTheme('hygge'); applyRoomHeight();
</script>
</body>
</html>
